import Groq from 'groq-sdk';
import { Anthropic } from '@anthropic-ai/sdk';
import { initializeDatabase, saveMemory, getRelevantMemory } from './database';
import * as dotenv from 'dotenv';
import express from 'express';
import { Octokit } from '@octokit/rest';

dotenv.config();

const groq = new Groq({ apiKey: process.env.GROQ_API_KEY });
const anthropic = new Anthropic({ apiKey: process.env.ANTHROPIC_API_KEY });
const octokit = new Octokit({ auth: process.env.GITHUB_TOKEN });

interface CodeReviewRequest {
  repo: string;
  pr_number: number;
  diff: string;
  useClaudeForCritical?: boolean;
}

interface SecurityIssue {
  type: string;
  severity: 'high' | 'medium' | 'low';
  line: string;
  description: string;
}

// Helper function to notify CMO about tech updates
async function notifyCMO(prData: {
  pr_number: number;
  repo: string;
  title: string;
  description: string;
  type: string;
  security_issues: number;
  complexity_issues: number;
}): Promise<boolean> {
  try {
    const CMO_WEBHOOK = 'https://vibejobhunter-production.up.railway.app/api/tech-update';
    
    console.log(`üì¢ Notifying CMO AIPA about PR #${prData.pr_number}...`);
    
    const response = await fetch(CMO_WEBHOOK, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(prData)
    });
    
    if (response.ok) {
      const result = await response.json() as { message: string };
      console.log(`‚úÖ CMO will announce PR #${prData.pr_number} at 4:30 PM Panama tomorrow!`);
      console.log(`   CMO said: ${result.message}`);
      return true;
    } else {
      console.log(`‚ö†Ô∏è CMO notification failed: ${response.status}`);
      return false;
    }
  } catch (error) {
    console.error(`‚ùå Error notifying CMO: ${error}`);
    return false;
  }
}

// Advanced code analysis functions
function analyzeSecurityIssues(diff: string): SecurityIssue[] {
  const issues: SecurityIssue[] = [];
  const lines = diff.split('\n');
  
  lines.forEach((line) => {
    if (line.includes('SELECT') && (line.includes('${') || line.includes('+') || line.includes('concat'))) {
      issues.push({
        type: 'SQL Injection Risk',
        severity: 'high',
        line: line.trim(),
        description: 'Potential SQL injection vulnerability. Use parameterized queries.'
      });
    }
    
    if (/(password|secret|api[_-]?key|token)\s*=\s*['"][^'"]+['"]/i.test(line)) {
      issues.push({
        type: 'Hardcoded Secret',
        severity: 'high',
        line: line.trim(),
        description: 'Hardcoded credentials detected. Use environment variables.'
      });
    }
    
    if ((line.includes('innerHTML') || line.includes('dangerouslySetInnerHTML')) && !line.includes('sanitize')) {
      issues.push({
        type: 'XSS Vulnerability',
        severity: 'high',
        line: line.trim(),
        description: 'Potential XSS vulnerability. Sanitize user input before rendering.'
      });
    }
    
    if (line.includes('eval(')) {
      issues.push({
        type: 'Dangerous Function',
        severity: 'high',
        line: line.trim(),
        description: 'Use of eval() is dangerous. Consider safer alternatives.'
      });
    }
    
    if (line.includes('console.log') && line.startsWith('+')) {
      issues.push({
        type: 'Debug Code',
        severity: 'low',
        line: line.trim(),
        description: 'console.log() found. Remove debug statements before production.'
      });
    }
  });
  
  return issues;
}

function analyzeCodeComplexity(diff: string): string[] {
  const issues: string[] = [];
  const lines = diff.split('\n');
  
  let functionLength = 0;
  let nestingLevel = 0;
  
  lines.forEach((line) => {
    if (line.startsWith('+')) {
      if (line.includes('function') || line.includes('=>')) {
        functionLength = 0;
      }
      functionLength++;
      
      const openBraces = (line.match(/{/g) || []).length;
      const closeBraces = (line.match(/}/g) || []).length;
      nestingLevel += openBraces - closeBraces;
      
      if (functionLength > 50) {
        issues.push('‚ö†Ô∏è Function exceeds 50 lines. Consider breaking it into smaller functions.');
        functionLength = 0;
      }
      
      if (nestingLevel > 4) {
        issues.push('‚ö†Ô∏è Deep nesting detected (>4 levels). Consider refactoring for better readability.');
      }
    }
  });
  
  return [...new Set(issues)];
}

function detectArchitecturePatterns(diff: string): string[] {
  const patterns: string[] = [];
  
  if (diff.includes('class') && diff.includes('extends')) {
    patterns.push('‚úÖ Object-Oriented Programming pattern detected');
  }
  
  if (diff.includes('async') && diff.includes('await')) {
    patterns.push('‚úÖ Async/Await pattern for asynchronous operations');
  }
  
  if (diff.includes('try') && diff.includes('catch')) {
    patterns.push('‚úÖ Proper error handling with try-catch blocks');
  }
  
  if (diff.includes('interface') || diff.includes('type')) {
    patterns.push('‚úÖ TypeScript type definitions for type safety');
  }
  
  if (!diff.includes('catch') && diff.includes('await')) {
    patterns.push('‚ö†Ô∏è Missing error handling for async operations');
  }
  
  return patterns;
}

function checkPerformanceIssues(diff: string): string[] {
  const issues: string[] = [];
  
  if (diff.includes('for') && diff.includes('for')) {
    issues.push('‚ö†Ô∏è Nested loops detected. Consider optimizing for O(n¬≤) complexity.');
  }
  
  if (diff.includes('.map(') && diff.includes('.filter(') && diff.includes('.map(')) {
    issues.push('‚ö†Ô∏è Multiple array iterations. Consider combining operations.');
  }
  
  if (diff.includes('JSON.parse(JSON.stringify(')) {
    issues.push('‚ö†Ô∏è Deep clone using JSON.parse/stringify is inefficient. Use structuredClone() or lodash cloneDeep().');
  }
  
  return issues;
}

async function reviewCode(request: CodeReviewRequest) {
  console.log(`ü§ñ CTO AIPA: Reviewing PR #${request.pr_number} in ${request.repo}...`);

  const context = await getRelevantMemory('CTO', 'code_review', 3);
  
  const securityIssues = analyzeSecurityIssues(request.diff);
  const complexityIssues = analyzeCodeComplexity(request.diff);
  const architecturePatterns = detectArchitecturePatterns(request.diff);
  const performanceIssues = checkPerformanceIssues(request.diff);

  const hasCriticalIssues = securityIssues.some(i => i.severity === 'high') ||
                             request.diff.includes('security') ||
                             request.diff.includes('payment') ||
                             request.useClaudeForCritical;

  const analysisSummary = `
Security Issues Found: ${securityIssues.length}
${securityIssues.map(i => `- [${i.severity.toUpperCase()}] ${i.type}: ${i.description}`).join('\n')}

Code Complexity Issues: ${complexityIssues.length}
${complexityIssues.join('\n')}

Architecture Patterns: ${architecturePatterns.length}
${architecturePatterns.join('\n')}

Performance Concerns: ${performanceIssues.length}
${performanceIssues.join('\n')}
`;

  const aiPrompt = `You are CTO AIPA, an AI Technical Co-Founder with expertise in software architecture, security, and best practices.

Analyze this code change and provide a comprehensive review:

AUTOMATED ANALYSIS RESULTS:
${analysisSummary}

CODE DIFF:
${request.diff}

PREVIOUS REVIEW CONTEXT:
${JSON.stringify(context)}

Provide a professional code review covering:
1. Critical security or architectural concerns (if any)
2. Code quality and best practices
3. Suggestions for improvement
4. Positive feedback on good practices

Keep the review constructive, specific, and actionable.`;

  let review: string;

  if (hasCriticalIssues) {
    console.log('üîê Using Claude for critical code review...');
    const response = await anthropic.messages.create({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 4096,
      messages: [{
        role: 'user',
        content: aiPrompt
      }]
    });
    const firstContent = response.content[0];
    review = firstContent && firstContent.type === 'text' ? firstContent.text : '';
  } else {
    console.log('‚ö° Using Groq for standard code review...');
    const response = await groq.chat.completions.create({
      model: 'llama-3.3-70b-versatile',
      messages: [{
        role: 'user',
        content: aiPrompt
      }]
    });
    review = response.choices[0]?.message?.content || '';
  }

  await saveMemory('CTO', 'code_review', {
    repo: request.repo,
    pr_number: request.pr_number,
    security_issues: securityIssues.length,
    complexity_issues: complexityIssues.length,
    performance_issues: performanceIssues.length
  }, review, {
    model_used: hasCriticalIssues ? 'claude' : 'groq',
    critical_issues: hasCriticalIssues,
    timestamp: new Date().toISOString()
  });

  console.log(`‚úÖ CTO AIPA: Review complete!`);
  
  return {
    review,
    securityIssues,
    complexityIssues
  };
}

async function startCTOAIPA() {
  console.log('üöÄ Starting CTO AIPA on Oracle Cloud...');
  
  await initializeDatabase();
  
  console.log('‚úÖ CTO AIPA ready and running on Oracle Cloud Infrastructure!');
  console.log('üí∞ Cost: $0 (using Oracle credits)');
  console.log('üîç Enhanced with: Security Scanning, Complexity Analysis, Architecture Detection');
  console.log('ü§ù Integrated with: CMO AIPA on Railway (tech update announcements)');
  
  const app = express();
  app.use(express.json());
  
  app.get('/', (req, res) => {
    res.json({ 
      status: 'running', 
      service: 'CTO AIPA',
      version: '2.1.0',
      features: [
        'Security Vulnerability Scanning',
        'Code Complexity Analysis',
        'Architecture Pattern Detection',
        'Performance Issue Detection',
        'AI-Powered Reviews (Groq + Claude)',
        'CMO Integration (LinkedIn Announcements)'
      ],
      integrations: {
        cmo_aipa: 'https://vibejobhunter-production.up.railway.app'
      },
      uptime: process.uptime()
    });
  });
  
  app.post('/webhook/github', async (req, res) => {
    const event = req.headers['x-github-event'];
    
    if (event === 'pull_request') {
      const pr = req.body.pull_request;
      const action = req.body.action;
      const repo = req.body.repository;
      
      if (action === 'opened' || action === 'synchronize') {
        console.log(`üì• New PR received: #${pr.number} - ${pr.title}`);
        console.log(`   Repository: ${repo.full_name}`);
        
        res.json({ status: 'processing', pr_number: pr.number });
        
        try {
          const [owner, repoName] = repo.full_name.split('/');
          const { data: prData } = await octokit.pulls.get({
            owner,
            repo: repoName,
            pull_number: pr.number,
            mediaType: { format: 'diff' }
          });
          
          console.log(`üìÑ Fetched diff for PR #${pr.number}`);
          
          const reviewResult = await reviewCode({
            repo: repo.full_name,
            pr_number: pr.number,
            diff: prData as unknown as string,
            useClaudeForCritical: false
          });
          
          await octokit.issues.createComment({
            owner,
            repo: repoName,
            issue_number: pr.number,
            body: `## ü§ñ CTO AIPA Code Review (v2.1 - Enhanced)\n\n${reviewResult.review}\n\n---\n*Powered by AI on Oracle Cloud | Security Scanning | Complexity Analysis | Architecture Detection*`
          });
          
          console.log(`‚úÖ Posted review comment on PR #${pr.number}`);
          
          // Notify CMO about this tech update
          const updateType = reviewResult.securityIssues.length > 0 ? 'security' : 
                           reviewResult.complexityIssues.length > 2 ? 'refactor' : 
                           'feature';
          
          await notifyCMO({
            pr_number: pr.number,
            repo: repo.full_name,
            title: pr.title,
            description: `CTO AIPA reviewed ${pr.changed_files || 'code'} changes. ${reviewResult.securityIssues.length > 0 ? `Found ${reviewResult.securityIssues.length} security improvements.` : ''} ${reviewResult.complexityIssues.length > 0 ? `Made ${reviewResult.complexityIssues.length} code quality enhancements.` : 'Code quality approved!'}`,
            type: updateType,
            security_issues: reviewResult.securityIssues.length,
            complexity_issues: reviewResult.complexityIssues.length
          });
          
        } catch (error) {
          console.error(`‚ùå Error processing PR #${pr.number}:`, error);
        }
        
      } else {
        res.json({ status: 'ignored', action });
      }
    } else {
      res.json({ status: 'ignored', event });
    }
  });
  
  const PORT = 3000;
  app.listen(PORT, '0.0.0.0', () => {
    console.log(`üéß CTO AIPA listening on http://163.192.99.45:${PORT}`);
    console.log(`üì° Webhook endpoint: http://163.192.99.45:${PORT}/webhook/github`);
    console.log(`üè• Health check: http://163.192.99.45:3000/`);
    console.log(`ü§ù CMO Integration: https://vibejobhunter-production.up.railway.app/api/tech-update`);
  });
}

startCTOAIPA().catch(console.error);

export { reviewCode };
